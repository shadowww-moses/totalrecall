# Shadow Properties

SP - это техника, позволяющая хранить в базе данных дополнительную информацию о сущности. В классе самой сущности поля для этой информации создавать не нужно, но при этом можно использовать эти поля в запросах. Это позволяет разгрузить сущности от некоторых вещей, которые могут не иметь отношения к бизнес-логике, но при этом хранят информацию, полезную в каких-то случаях.

<img src="img\image-20200508110153477.png" alt="image-20200508110153477" style="zoom:80%;" />

## Создание SP

SP объявляются в методе `OnModelCreating` контекста:

<img src="img\image-20200508110753748.png" alt="image-20200508110753748" style="zoom:80%;" />

Если нужно создать одинаковые SP для множества сущностей, можно сделать это в цикле:

<img src="img\image-20200508125233278.png" alt="image-20200508125233278" style="zoom:80%;" />

## Запись и чтение SP

Запись:

<img src="img\image-20200508134824830.png" alt="image-20200508134824830" style="zoom:80%;" />

А с помощью проекции можно выбрать значение SP:

<img src="img\image-20200508142204248.png" alt="image-20200508142204248" style="zoom:80%;" />

## Использование SP в запросах

<img src="img\image-20200508141436211.png" alt="image-20200508141436211" style="zoom:80%;" />



## SP и перегрузка SaveChanges()

Интересный пример, позволяющий при сохранении объектов заполнять их SP времени создания и последнего доступа:

<img src="img\image-20200508141036962.png" alt="image-20200508141036962" style="zoom:80%;" />

# Entity и Entry

**Entity** - это сущность, тип. Поэтому обычно используется в разных конфигурационных методах:

<img src="img\image-20200509090932633.png" alt="image-20200509090932633" style="zoom:80%;" />

**Entry** - это экземпляр сущности. По экземпляру можно через контекст добраться до SP этой сущности, а также, например, контролировать состояние каждого экземпляра вручную:

<img src="img\image-20200509084231112.png" alt="image-20200509084231112" style="zoom:80%;" />

В этом примере показано как управлять состоянием отдельного экземпляра сущности вручную. В данном случае это нужно, потому что из-за disconnected-сценария мы должны как-то самостоятельно сообщить контексту, что именно мы изменили. 

Если выполнить `contextPost.Playlists.Update(playlist)` то контекст обновит все плейлисты пользователя и даже самого пользователя. Поэтому мы явно указываем для отдельно взятой цитаты состояние Modified, чтобы избежать лишних операций обновления.



# ???Owned Types

> Возникла проблема с созданием OT. Решить пока не удалось.
>
> The type 'Uzername' cannot be marked as owned because a non-owned entity type with the same name already exists.
>
> Пробовал менять имя поля, чтобы оно отличалось от имени типа, не помогло. Гугление ответа не дало

Есть категория объектов, которые не имеют идентификатора (ключа). В терминах DDD они называются Value Objects. 

Однако в EF все сущности должны иметь ключ. Поэтому для решения этого вопроса и хранения такой категории объектов существуют Owned Types.

## Создание OT

* Создаем обычный класс:

  <img src="img\image-20200508144643851.png" alt="image-20200508144643851" style="zoom:80%;" />

  Обязательно должен присутствовать конструктор без параметров. Можно сделать его приватным, это неважно, потому что EF получает его через рефлексию.

* Добавляем поле этого типа в желаемый класс:

  <img src="img\image-20200508145432350.png" alt="image-20200508145432350" style="zoom:80%;" />

* В `OnModelCreating` контекста явно указываем, что это не сущность, а Owned Type

