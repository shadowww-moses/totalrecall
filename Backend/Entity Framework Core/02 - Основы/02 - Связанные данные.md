# Связанные данные

Выборка объекта пользователя не означает выборку связанных с ним объектов, например, каналов и плейлистов. То есть список любимых каналов будет null, если специально не догрузить его. Это относится ко всем типам связей.

Существует несколько способов загрузить связанные данные:

<img src="img\image-20200507140556985.png" alt="image-20200507140556985" style="zoom:80%;" />

## Жадная загрузка

Поля, содержащие связанные объекты, явно указываются в запросе через методы `Include` и `ThenInclude`:

<img src="img\image-20200507141417510.png" alt="image-20200507141417510" style="zoom:80%;" />

Через Include подключаем "первый уровень связи", в данном случае промежуточную таблицу, подписки, через ThenInclude - второй, уже непосредственно каналы.

Через Include в одном запросе можно выбрать в память сразу несколько связанных объектов. То есть не только избранные каналы, но и плейлисты:

<img src="img\image-20200507142624833.png" alt="image-20200507142624833" style="zoom:80%;" />

Не имеет значения, что ставить сначала - Where или Include.

Include и ThenInclude - это методы DbSet, поэтому их нельзя применять, например, после операторов Find, FirstOrDefault и других, которые возвращают уже конкретный объект.

Include и ThenInclude загружают все связанные данные. Фильтровать их непосредственно в самом Include нельзя (но, к слову, у меня получилось это сделать в разделе проекции). Например, в следующем фрагменте запрос просто не видит поле с каналом, чтобы можно было задать для него какие-то условия:

<img src="img\image-20200507155357870.png" alt="image-20200507155357870" style="zoom:80%;" />

## Проекция

Если в методе Select использовать поля, содержащие связанные объекты, то они сами загружаются в память:

<img src="img\image-20200507150616074.png" alt="image-20200507150616074" style="zoom:80%;" />

Внешние .Where и .Select возвращают IQueryable, а внутренние - уже IEnumerable, что говорит о том, что в поле Channels анонимного объекта действительно будут данные, а не просто запрос.

Кроме того, в проекции я выполнил фильтрацию каналов, отобрав только только те каналы пользователя, которые предназначены для взрослых.

## Явная загрузка

Явная загрузка используется, когда главный объект уже находится в памяти и требуется догрузить связанные объекты.

* Для связи типа 1:М догрузка делается методом `Collection`:

<img src="img\image-20200507160502303.png" alt="image-20200507160502303" style="zoom:80%;" />

* Для связи типа 1:1 - методом `Reference`:

  <img src="img\image-20200507161527300.png" alt="image-20200507161527300" style="zoom:80%;" />

* Для связи типа М:М:

  В курсе не было, сам не нашел.

Догрузку можно делать только для одного объекта. Поэтому, если у нас несколько пользователей, которым нужна догрузка, то эффективнее будет сделать новый запрос, чем, например, в цикле делать догрузку явным способом.

Можно догружать не все связанные данные, а по условию:

<img src="img\image-20200507165543880.png" alt="image-20200507165543880" style="zoom:80%;" />

Для связи 1:1 у меня не получилось сделать.

## Ленивая загрузка

Ленивая загрузка позволяет автоматически загружать связанные данные, когда к ним происходит какое-либо обращение.

<img src="img\image-20200507171422228.png" alt="image-20200507171422228" style="zoom:80%;" />

Чтобы она работала, необходимо выполнить три действия:

* Поставить в сборку с контекстом пакет `Microsoft.EntityFrameworkCore.Proxies`

* Подключить ленивую загрузку при конфигурации контекста:

  <img src="img\image-20200507171725443.png" alt="image-20200507171725443" style="zoom:80%;" />

* Объявить все навигационные свойства во всех сущностях виртуальными:

  <img src="img\image-20200507172223283.png" alt="image-20200507172223283" style="zoom:80%;" />

Ленивая загрузка делает получение связанных данных менее очевидным плюс делает над сущностью обертку, искажая ее тип.

# Условия к связанным данным

Можно выбирать объекты на основе условий к их связанным данным. При этом не обязательно загружать связанные данные, если они не нужны непосредственно в результате:

<img src="img\image-20200507162819326.png" alt="image-20200507162819326" style="zoom:80%;" />

Выбрали пользователей, у который в домашней странице встречается часть "org".

<img src="img\image-20200507163336345.png" alt="image-20200507163336345" style="zoom:80%;" />

Выбрали пользователей, у который больше двух избранных каналов.
