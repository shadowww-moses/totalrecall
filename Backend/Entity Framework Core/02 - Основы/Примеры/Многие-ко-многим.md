

# Добавление

## Через промежуточную сущность

* Пользователь и канал уже существуют. Добавление делаем через передачу ключей в новый объект промежуточной сущности:

  <img src="\..\img\image-20200504103704878.png" alt="image-20200504103704878" style="zoom:80%;" />

  Мы явно создаем объект связующей сущности `Subscription`, заполняем его и, поскольку DbSet для этой сущности отсутствует, пользуемся для добавления методом контекста.

* Пользователь и канал уже существуют. Добавление делаем через передачу объектов пользователя и канала в промежуточную сущность:

  <img src="\..\img\image-20200504103850634.png" alt="image-20200504103850634" style="zoom:80%;" />

  Делаем то же самое, только вместо ключей указываем объекты. Этот вариант возможен, только если в промежуточной сущности есть навигационные свойства.

  Для этого примера возможен **Disconnected** сценарий:

  <img src="\..\img\image-20200504121757597.png" alt="image-20200504121757597" style="zoom:80%;" />

  Интерес вызывает то, что если вместо метода Attach использовать Add, то будет ошибка, потому что, как было описано в разделе про трекинг объектов, метод задает состояние для всего графа объектов, а не только для корня. Хотя нам действительно надо добавить новый, еще не существующий, объект подписки в таблицу, но при использовании Add объекты пользователя и канала тоже получат состояние *Added* и EF при сохранении изменений попробует их добавить в таблицы. Но поскольку эти объекты уже существуют, возникнет ошибка.

  Поэтому мы используем метод Attach, который, как опять же писалось в разделе про трекинг, поставит объекту подписки статус *Added*, потому что он определится как новый за счет того, что у него еще нет значений ключа, а объекты пользователя и канала получат статус *Unchanged*, потому что это стандартный статус при методе Attach. Таким образом, новая подписка вставится в таблицу, а пользователь и канал останутся нетронутыми из-за статуса Unchanged, и операция завершится как надо.

* Ни пользователь, ни канал не существуют. Добавление делаем через объекты, используя промежуточную сущность:

  <img src="\..\img\image-20200504105738141.png" alt="image-20200504105738141" style="zoom:80%;" />

  В данном случае EF автоматически сначала добавит новых пользователя и канал в таблицы `Users` и `Channels`, получит их Id, а затем свяжет их в промежуточной таблице. Disconnected сценарий здесь рассматривать нет смысла, потому что все объекты новые, следовательно добавляются через Add и никаких тонкостей нет.

## Через один из объектов

Промежуточную сущность не обязательно явно добавлять в контекст. Можно добавить ее через объект какой-либо стороны отношения М:М:

* Пользователь и канал существуют. Добавление делаем через объект пользователя с помощью ключа:

  <img src="\..\img\image-20200504110619717.png" alt="image-20200504110619717" style="zoom:80%;" />

  Если до этого мы создавали объект `Subscription` и самостоятельно добавляли его в таблицу с помощью контекста, то в этом примере демонстрируется как добавить его с помощью объекта пользователя. В таком случае для Subscription не нужно указывать объект пользователя - он сам поймет, с каким пользователем идет операция.

  Касаемо формирования объекта `Subscription`, можно использовать те же подходы, что и в предыдущих примерах - например, давать не Id канала, а объект; подписывать не на существующий канал, а на только что созданный, и т.д. За счет того, что контекст после нахождения объекта начинает его отслеживать, после добавления подписки не требуется никаких дополнительных действий, кроме вызова сохранения.

  А вот пара примеров, демонстрирующих **disconnected** сценарий:

  

  <img src="\..\img\image-20200504141157337.png" alt="image-20200504141157337" style="zoom:80%;" />

  

<img src="\..\img\image-20200504141230632.png" alt="image-20200504141230632" style="zoom:80%;" />

* Подписка сразу на несколько каналов (придумал сам, может есть и другой способ):

  <img src="\..\img\image-20200504160916690.png" alt="image-20200504160916690" style="zoom:80%;" />

# Выборка

* Выбор всех любимых каналов пользователя:

  <img src="\..\img\image-20200507083539682.png" alt="image-20200507083539682" style="zoom:80%;" />

  <img src="\..\img\image-20200508080639714.png" alt="image-20200508080639714" style="zoom:80%;" />



# Изменение

Изменение проще всего делается удалением записи из связующей таблицы и добавлением новой:

<img src="\..\img\image-20200508084142913.png" alt="image-20200508084142913" style="zoom:80%;" />

Я попытался найти объект подписки через пользователя и заменить в ней канал, но возникла ошибка типа нельзя заменять значение первичного ключа. Поэтому думаю просто удалить подписку и добавить правильную самый оптимальный вариант.

# Удаление

* Можно производить удаление подписки непосредственно:

<img src="\..\img\image-20200508081320702.png" alt="image-20200508081320702" style="zoom:80%;" />

Или

<img src="\..\img\image-20200508090659526.png" alt="image-20200508090659526" style="zoom:80%;" />

* Можно производить удаление через объект пользователя:

  <img src="\..\img\image-20200508092258865.png" alt="image-20200508092258865" style="zoom:80%;" />

  В случае Disconnected сценария нужно еще дополнительно явно удалить сущность через контекст, потому что объект пользователя не отслеживается и удаления только из его внутреннего списка будет недостаточно:

  <img src="\..\img\image-20200508092722188.png" alt="image-20200508092722188" style="zoom:80%;" />
